<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckEngineRD Unlimited - Sistema de Citas</title>
    <!-- Importación de Bootstrap CSS y Font Awesome para íconos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .logo {
            max-width: 180px;
            height: auto;
        }
        
        .navbar-custom {
            background-color: var(--primary-color);
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--secondary-color);
        }
        
        .card-header-custom {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary-custom {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary-custom:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .stat-card {
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .finanzas-icon {
            font-size: 1.2rem;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .badge {
            font-size: 0.85em;
        }
        
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        
        .btn-copiar {
            position: absolute;
            right: 15px;
            top: -45px;
        }
        
        .modal-backdrop {
            z-index: 1040 !important;
        }
        
        .modal {
            z-index: 1050 !important;
        }
        
        .tooltip-inner {
            max-width: 350px;
        }
        
        /* Estilos para el modal de agentes */
        .agente-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .agente-item:hover {
            background-color: #f8f9fa;
        }
        
        /* Nuevos estilos para la interfaz mejorada */
        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        
        .dashboard-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .summary-widget {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .main-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }
        
        .welcome-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .config-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .welcome-header h1 {
                font-size: 1.8rem;
            }
            
            .summary-value {
                font-size: 1.5rem;
            }
        }
        
        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin-top: 10px;
            border: 1px dashed #ccc;
            padding: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img id="headerLogo" src="https://placehold.co/180x50/ffffff/3498db?text=CheckEngineRD" alt="Checkenginerd Unlimited" class="logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#configuracionModal"><i class="fas fa-cog me-1"></i> Configuración</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="welcome-header text-center">
            <h1><i class="fas fa-calendar-check me-2"></i> <span id="headerEmpresaNombre">CheckEngineRD Unlimited</span></h1>
            <p class="lead">Sistema de Gestión de Citas</p>
        </div>

        <!-- Mensaje de confirmación o error -->
        <div id="mensajeContainer" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 1050; display: none;">
            <div id="mensajeAlerta" class="alert fade show" role="alert"></div>
        </div>

        <!-- Panel de resumen -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-widget text-center">
                    <div class="summary-value" id="resumenTotal">0</div>
                    <div>Total Citas</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-widget text-center">
                    <div class="summary-value" id="resumenHoy">0</div>
                    <div>Citas Hoy</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-widget text-center">
                    <div class="summary-value" id="resumenPendientes">0</div>
                    <div>Pendientes</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-widget text-center">
                    <div class="summary-value" id="resumenFacturado">$0</div>
                    <div>Facturado</div>
                </div>
            </div>
        </div>

        <!-- Navegación por pestañas -->
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-citas-tab" data-bs-toggle="pill" data-bs-target="#pills-citas" type="button" role="tab" aria-controls="pills-citas" aria-selected="true">
                    <i class="fas fa-list me-1"></i> Gestionar Citas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-nueva-tab" data-bs-toggle="pill" data-bs-target="#pills-nueva" type="button" role="tab" aria-controls="pills-nueva" aria-selected="false">
                    <i class="fas fa-plus-circle me-1"></i> Nueva Cita
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-reportes-tab" data-bs-toggle="pill" data-bs-target="#pills-reportes" type="button" role="tab" aria-controls="pills-reportes" aria-selected="false">
                    <i class="fas fa-chart-bar me-1"></i> Reportes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-agentes-tab" data-bs-toggle="pill" data-bs-target="#pills-agentes" type="button" role="tab" aria-controls="pills-agentes" aria-selected="false">
                    <i class="fas fa-users me-1"></i> Agentes
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="pills-tabContent">
            <!-- Pestaña de Gestión de Citas -->
            <div class="tab-pane fade show active" id="pills-citas" role="tabpanel" aria-labelledby="pills-citas-tab">
                <!-- Sección de Filtros, Estadísticas, Exportar y Guardar -->
                <div class="row mb-3" id="filtros">
                    <div class="col-md-12">
                        <div class="card dashboard-card">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros y Acciones</h5>
                            </div>
                            <div class="card-body py-2 d-flex flex-wrap justify-content-between align-items-center">
                                <fieldset id="grupo-filtros" class="btn-group btn-group-sm mb-2 mb-md-0 me-md-2">
                                    <legend class="visually-hidden">Filtros por estado de cita</legend>
                                    <button type="button" class="btn btn-outline-primary active" data-estado="todas">Todas</button>
                                    <button type="button" class="btn btn-outline-secondary" data-estado="pendiente">Pendientes</button>
                                    <button type="button" class="btn btn-outline-info" data-estado="recibido">Recibidos</button>
                                    <button type="button" class="btn btn-outline-success" data-estado="completada">Completadas</button>
                                    <button type="button" class="btn btn-outline-warning" data-estado="reagendada">Reagendadas</button>
                                    <button type="button" class="btn btn-outline-danger" data-estado="no_asistio">No Asistieron</button>
                                    <button type="button" class="btn btn-outline-dark" data-estado="cancelada">Canceladas</button>
                                </fieldset>
                                <div class="btn-group" role="group">
                                    <button id="btnExportarExcel" class="btn btn-success">
                                        <i class="fas fa-file-excel"></i> Exportar
                                    </button>
                                    <button id="btnGuardarManual" class="btn btn-primary">
                                        <i class="fas fa-download"></i> Guardar
                                    </button>
                                    <label for="importarArchivo" class="btn btn-info mb-0">
                                        <i class="fas fa-upload"></i> Importar JSON
                                    </label>
                                    <input type="file" id="importarArchivo" class="d-none" accept=".json">
                                    <button id="btnImportarExcel" class="btn btn-warning">
                                        <i class="fas fa-file-import"></i> Importar Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Estadísticas y Filtro Diario y Mensual -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estadísticas y Filtros Avanzados</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-3 mb-2 mb-md-0">
                                <label for="filtroFecha" class="form-label">Filtrar por Día:</label>
                                <input type="date" class="form-control" id="filtroFecha">
                            </div>
                            <div class="col-md-3 mb-2 mb-md-0">
                                <label for="filtroMes" class="form-label">Filtrar por Mes:</label>
                                <select class="form-select" id="filtroMes">
                                    <option value="">Todos los meses</option>
                                    <option value="01">Enero</option>
                                    <option value="02">Febrero</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Mayo</option>
                                    <option value="06">Junio</option>
                                    <option value="07">Julio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2 mb-md-0">
                                <label for="filtroAnio" class="form-label">Filtrar por Año:</label>
                                <select class="form-select" id="filtroAnio">
                                    <option value="">Todos los años</option>
                                    <!-- Los años se cargarán dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="filtroFacturado">
                                    <label class="form-check-label" for="filtroFacturado">Mostrar solo facturados</label>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center" id="estadisticasDiarias">
                            <div class="col-md-3 mb-2">
                                <div class="card h-100 stat-card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Total de Citas</h6>
                                        <p class="stat-value text-primary" id="statsTotal">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="card h-100 stat-card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Recibidas</h6>
                                        <p class="stat-value text-info" id="statsRecibidas">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="card h-100 stat-card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Monto Facturado</h6>
                                        <p class="stat-value text-success" id="statsMonto">$0.00 RD</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="card h-100 stat-card">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted">Efectividad</h6>
                                        <p class="stat-value text-dark" id="statsEfectividad">0%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tarjeta para citas programadas y tabla -->
                <div class="card dashboard-card mb-4 position-relative">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Citas Programadas</h5>
                        <button id="btnCopiarLista" class="btn btn-sm btn-light" title="Copiar lista de citas">
                            <i class="fas fa-copy me-1"></i>Copiar Lista
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Cliente</th>
                                        <th>Marca</th>
                                        <th>Modelo</th>
                                        <th>Año</th>
                                        <th>Agente</th>
                                        <th>Estado</th>
                                        <th>Finanzas</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="listaCitas">
                                    <!-- Las citas se cargarán aquí dinámicamente con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Nueva Cita -->
            <div class="tab-pane fade" id="pills-nueva" role="tabpanel" aria-labelledby="pills-nueva-tab">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <!-- Tarjeta para crear nueva cita -->
                        <div class="card dashboard-card">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i>Nueva Cita</h5>
                            </div>
                            <div class="card-body">
                                <form id="citaForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="nombreCliente" class="form-label">Nombre del Cliente*</label>
                                            <input type="text" class="form-control" id="nombreCliente" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="telefono" class="form-label">Teléfono*</label>
                                            <input type="tel" class="form-control" id="telefono" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="marca" class="form-label">Marca*</label>
                                            <input type="text" class="form-control" id="marca" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="modelo" class="form-label">Modelo*</label>
                                            <input type="text" class="form-control" id="modelo" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="anio" class="form-label">Año*</label>
                                            <input type="number" class="form-control" id="anio" min="1900" max="2099" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fecha" class="form-label">Fecha de Servicio*</label>
                                            <input type="date" class="form-control" id="fecha" required min="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="hora" class="form-label">Hora de Servicio*</label>
                                            <select class="form-select" id="hora" required>
                                                <option value="08:00">8:00 AM</option>
                                                <option value="09:00">9:00 AM</option>
                                                <option value="10:00">10:00 AM</option>
                                                <option value="11:00">11:00 AM</option>
                                                <option value="12:00">12:00 PM</option>
                                                <option value="13:00">1:00 PM</option>
                                                <option value="14:00">2:00 PM</option>
                                                <option value="15:00">3:00 PM</option>
                                                <option value="16:00">4:00 PM</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="servicio" class="form-label">Tipo de Servicio*</label>
                                        <select class="form-select" id="servicio" required>
                                            <option value="">Seleccione un servicio...</option>
                                            <option value="Chequeo General">Chequeo General</option>
                                            <option value="Chequeo libre de costo">Chequeo libre de costo</option>
                                            <option value="Mantenimiento Inyección">Mantenimiento Inyección</option>
                                            <option value="Cambio de Aceite">Cambio de Aceite</option>
                                            <option value="Diagnóstico Computarizado">Diagnóstico Computarizado</option>
                                            <option value="Trabajo a Realizar">Trabajo a Realizar</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="otroServicioContainer" style="display: none;">
                                        <label for="otroServicio" class="form-label">Especificar Servicio</label>
                                        <input type="text" class="form-control" id="otroServicio">
                                    </div>
                                    <div class="mb-3">
                                        <label for="notas" class="form-label">Notas Adicionales</label>
                                        <textarea class="form-control" id="notas" rows="3" placeholder="Describa cualquier problema o detalle adicional..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="agente" class="form-label">Agente de Ventas</label>
                                        <div class="input-group">
                                            <select class="form-select" id="agente" required>
                                                <option value="">Seleccione un agente...</option>
                                                <!-- Los agentes se cargarán dinámicamente -->
                                            </select>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#gestionAgentesModal">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary-custom w-100 py-2">
                                        <i class="fas fa-save me-2"></i>Programar Cita
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Reportes -->
            <div class="tab-pane fade" id="pills-reportes" role="tabpanel" aria-labelledby="pills-reportes-tab">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card dashboard-card h-100">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Resumen por Estado</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="estadoChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card dashboard-card h-100">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Facturación Mensual</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="facturacionChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card dashboard-card">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Reporte Detallado</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Agente</th>
                                        <th>Citas Programadas</th>
                                        <th>Citas Completadas</th>
                                        <th>Monto Facturado</th>
                                        <th>Efectividad</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaReportes">
                                    <!-- Los reportes se generarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Gestión de Agentes -->
            <div class="tab-pane fade" id="pills-agentes" role="tabpanel" aria-labelledby="pills-agentes-tab">
                <div class="card dashboard-card">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Gestión de Agentes</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#gestionAgentesModal">
                            <i class="fas fa-plus me-1"></i>Agregar Agente
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaAgentes">
                                    <!-- Los agentes se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para importar desde Excel -->
    <div class="modal fade" id="importarExcelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Importar desde Excel/CSV</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="archivoExcel" class="form-label">Seleccionar archivo Excel/CSV</label>
                        <input class="form-control" type="file" id="archivoExcel" accept=".xlsx,.xls,.csv">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Opciones de importación</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="corregirFechas" checked>
                            <label class="form-check-label" for="corregirFechas">
                                Corregir formato de fechas automáticamente
                            </label>
                        </div>
                        <small class="form-text text-muted">Esta opción intentará detectar y corregir formatos de fecha incorrectos durante la importación.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vista previa de datos</label>
                        <div class="import-preview table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Teléfono</th>
                                        <th>Marca</th>
                                        <th>Modelo</th>
                                        <th>Año</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Servicio</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="vistaPreviaDatos">
                                    <tr>
                                        <td colspan="9" class="text-center">No hay datos para mostrar</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sobrescribirDatos">
                        <label class="form-check-label" for="sobrescribirDatos">
                            Sobrescribir datos existentes
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarImportacion">Importar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para seleccionar agente -->
    <div class="modal fade" id="seleccionarAgenteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Seleccionar Agente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filtroAgente" class="form-label">Filtrar agentes:</label>
                        <input type="text" class="form-control" id="filtroAgente" placeholder="Buscar agente...">
                    </div>
                    <div class="list-group" id="listaAgentes">
                        <!-- Lista de agentes se cargará aquí -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSeleccionarAgente">Seleccionar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el cupón -->
    <div class="modal fade" id="cuponModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Cupón de Servicio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0" id="cuponContent">
                    <!-- Contenido del cupón se generará aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="imprimirCupon()">
                        <i class="fas fa-print me-1"></i>Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar cita -->
    <div class="modal fade" id="editarCitaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Editar Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editarCitaForm">
                        <input type="hidden" id="editarId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editarNombreCliente" class="form-label">Nombre del Cliente*</label>
                                <input type="text" class="form-control" id="editarNombreCliente" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editarTelefono" class="form-label">Teléfono*</label>
                                <input type="tel" class="form-control" id="editarTelefono" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="editarMarca" class="form-label">Marca*</label>
                                <input type="text" class="form-control" id="editarMarca" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editarModelo" class="form-label">Modelo*</label>
                                <input type="text" class="form-control" id="editarModelo" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="editarAnio" class="form-label">Año*</label>
                                <input type="number" class="form-control" id="editarAnio" min="1900" max="2099" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editarFecha" class="form-label">Fecha de Servicio*</label>
                                <input type="date" class="form-control" id="editarFecha" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editarHora" class="form-label">Hora de Servicio*</label>
                                <select class="form-select" id="editarHora" required>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editarServicio" class="form-label">Tipo de Servicio*</label>
                            <select class="form-select" id="editarServicio" required>
                                <option value="">Seleccione un servicio...</option>
                                <option value="Chequeo General">Chequeo General</option>
                                <option value="Chequeo libre de costo">Chequeo libre de costo</option>
                                <option value="Mantenimiento Inyección">Mantenimiento Inyección</option>
                                <option value="Cambio de Aceite">Cambio de Aceite</option>
                                <option value="Diagnóstico Computarizado">Diagnóstico Computarizado</option>
                                <option value="Trabajo a Realizar">Trabajo a Realizar</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="mb-3" id="editarOtroServicioContainer" style="display: none;">
                            <label for="editarOtroServicio" class="form-label">Especificar Servicio</label>
                            <input type="text" class="form-control" id="editarOtroServicio">
                        </div>
                        <div class="mb-3">
                            <label for="editarNotas" class="form-label">Notas Adicionales</label>
                            <textarea class="form-control" id="editarNotas" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editarAgente" class="form-label">Agente de Ventas</label>
                            <select class="form-select" id="editarAgente">
                                <option value="">Seleccione un agente...</option>
                                <!-- Los agentes se cargarán dinámicamente -->
                            </select>
                        </div>
                        <hr>
                        <h6 class="fw-bold">Datos Financieros y de Estado</h6>
                        <div class="mb-3">
                            <label for="editarEstado" class="form-label">Estado</label>
                            <select class="form-select" id="editarEstado">
                                <option value="pendiente">Pendiente</option>
                                <option value="recibido">Recibido</option>
                                <option value="completada">Completada</option>
                                <option value="reagendada">Reagendada</option>
                                <option value="no_asistio">No Asistió</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input class="form-check-input" type="checkbox" id="editarFacturado">
                            <label class="form-check-label" for="editarFacturado">
                                ¿Facturado?
                            </label>
                        </div>
                        <div class="mb-3" id="editarMontoContainer">
                            <label for="editarMonto" class="form-label">Monto Facturado (<span id="simboloMoneda">$</span>)</label>
                            <div class="input-group">
                                <span class="input-group-text" id="simboloMonedaInput">$</span>
                                <input type="text" class="form-control" id="editarMonto" placeholder="0.00">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editarTieneCotizacion" class="form-label">¿Tiene Cotización?</label>
                            <select class="form-select" id="editarTieneCotizacion">
                                <option value="no_aplica">No aplica</option>
                                <option value="si">Sí</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="mb-3" id="editarMotivoCotizacionContainer" style="display: none;">
                            <label for="editarMotivoCotizacion" class="form-label">Motivo de no tener cotización</label>
                            <textarea class="form-control" id="editarMotivoCotizacion" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnGuardarEdicion">
                        <i class="fas fa-save me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres eliminar esta cita?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuración -->
    <div class="modal fade" id="configuracionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Configuración del Sistema</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="config-section">
                        <h5 class="mb-3"><i class="fas fa-building me-2"></i>Datos de la Empresa</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="configNombreEmpresa" class="form-label">Nombre de la Empresa</label>
                                <input type="text" class="form-control" id="configNombreEmpresa" value="CheckEngineRD Unlimited">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="configSucursal" class="form-label">Sucursal</label>
                                <input type="text" class="form-control" id="configSucursal" value="Santo Domingo">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="configDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="configDireccion" value="Av. de los Próceres 25, Santo Domingo">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="configTelefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="configTelefono" value="(809) 555-1234">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h5 class="mb-3"><i class="fas fa-image me-2"></i>Logo de la Empresa</h5>
                        <div class="mb-3">
                            <label for="configLogo" class="form-label">Seleccionar Logo</label>
                            <input class="form-control" type="file" id="configLogo" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vista Previa</label>
                            <div>
                                <img id="logoPreview" src="https://placehold.co/180x50/ffffff/3498db?text=CheckEngineRD" class="logo-preview">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h5 class="mb-3"><i class="fas fa-money-bill-wave me-2"></i>Configuración Monetaria</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="configMoneda" class="form-label">Moneda</label>
                                <select class="form-select" id="configMoneda">
                                    <option value="RD">Peso Dominicano (RD$)</option>
                                    <option value="USD">Dólar Estadounidense (USD$)</option>
                                    <option value="EUR">Euro (€)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="configFormatoMoneda" class="form-label">Formato de Moneda</label>
                                <select class="form-select" id="configFormatoMoneda">
                                    <option value="es-DO">Formato Dominicano (RD$ 1,000.00)</option>
                                    <option value="en-US">Formato Estadounidense ($1,000.00)</option>
                                    <option value="de-DE">Formato Europeo (1.000,00 €)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarConfiguracion">Guardar Configuración</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gestión de Agentes -->
    <div class="modal fade" id="gestionAgentesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i>Gestión de Agentes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="agenteForm">
                        <input type="hidden" id="agenteId">
                        <div class="mb-3">
                            <label for="agenteNombre" class="form-label">Nombre completo*</label>
                            <input type="text" class="form-control" id="agenteNombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="agenteEmail" class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="agenteEmail">
                        </div>
                        <div class="mb-3">
                            <label for="agenteTelefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="agenteTelefono">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="agenteActivo" checked>
                            <label class="form-check-label" for="agenteActivo">Agente activo</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnEliminarAgente" style="display: none;">Eliminar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarAgente">Guardar Agente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Bootstrap y JavaScript personalizado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS para importación de Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Citas de ejemplo (se cargan del localStorage) ---
        let citas = [];
        let agentes = [];
        let configuracion = {
            nombreEmpresa: "CheckEngineRD Unlimited",
            sucursal: "Santo Domingo",
            direccion: "Av. de los Próceres 25, Santo Domingo",
            telefono: "(809) 555-1234",
            moneda: "RD",
            formatoMoneda: "es-DO",
            logo: "https://placehold.co/180x50/ffffff/3498db?text=CheckEngineRD"
        };

        // --- Selectores del DOM ---
        const citaForm = document.getElementById('citaForm');
        const listaCitas = document.getElementById('listaCitas');
        const grupoFiltros = document.getElementById('grupo-filtros');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnGuardarManual = document.getElementById('btnGuardarManual');
        const btnImportarExcel = document.getElementById('btnImportarExcel');
        const btnCopiarLista = document.getElementById('btnCopiarLista');
        const importarArchivoInput = document.getElementById('importarArchivo');
        const servicioSelect = document.getElementById('servicio');
        const otroServicioContainer = document.getElementById('otroServicioContainer');
        const otroServicioInput = document.getElementById('otroServicio');
        const filtroFechaInput = document.getElementById('filtroFecha');
        const filtroMesSelect = document.getElementById('filtroMes');
        const filtroAnioSelect = document.getElementById('filtroAnio');
        const filtroFacturadoInput = document.getElementById('filtroFacturado');
        const archivoExcelInput = document.getElementById('archivoExcel');
        const vistaPreviaDatos = document.getElementById('vistaPreviaDatos');
        const btnConfirmarImportacion = document.getElementById('btnConfirmarImportacion');
        const importarExcelModalEl = document.getElementById('importarExcelModal');
        const importarExcelModal = new bootstrap.Modal(importarExcelModalEl);
        const seleccionarAgenteModalEl = document.getElementById('seleccionarAgenteModal');
        const seleccionarAgenteModal = new bootstrap.Modal(seleccionarAgenteModalEl);
        const listaAgentes = document.getElementById('listaAgentes');
        const filtroAgente = document.getElementById('filtroAgente');
        const btnSeleccionarAgente = document.getElementById('btnSeleccionarAgente');
        const agenteSelect = document.getElementById('agente');
        const configuracionModalEl = document.getElementById('configuracionModal');
        const configuracionModal = new bootstrap.Modal(configuracionModalEl);
        const gestionAgentesModalEl = document.getElementById('gestionAgentesModal');
        const gestionAgentesModal = new bootstrap.Modal(gestionAgentesModalEl);
        const agenteForm = document.getElementById('agenteForm');
        const btnGuardarAgente = document.getElementById('btnGuardarAgente');
        const btnEliminarAgente = document.getElementById('btnEliminarAgente');
        const tablaAgentes = document.getElementById('tablaAgentes');

        // Modal para editar
        const editarCitaModalEl = document.getElementById('editarCitaModal');
        const editarCitaForm = document.getElementById('editarCitaForm');
        const btnGuardarEdicion = document.getElementById('btnGuardarEdicion');
        const editarIdInput = document.getElementById('editarId');
        const editarNombreClienteInput = document.getElementById('editarNombreCliente');
        const editarTelefonoInput = document.getElementById('editarTelefono');
        const editarMarcaInput = document.getElementById('editarMarca');
        const editarModeloInput = document.getElementById('editarModelo');
        const editarAnioInput = document.getElementById('editarAnio');
        const editarFechaInput = document.getElementById('editarFecha');
        const editarHoraInput = document.getElementById('editarHora');
        const editarServicioSelect = document.getElementById('editarServicio');
        const editarOtroServicioContainer = document.getElementById('editarOtroServicioContainer');
        const editarOtroServicioInput = document.getElementById('editarOtroServicio');
        const editarNotasInput = document.getElementById('editarNotas');
        const editarAgenteInput = document.getElementById('editarAgente');
        const editarEstadoSelect = document.getElementById('editarEstado');
        const editarFacturadoInput = document.getElementById('editarFacturado');
        const editarMontoInput = document.getElementById('editarMonto');
        const editarTieneCotizacionSelect = document.getElementById('editarTieneCotizacion');
        const editarMotivoCotizacionContainer = document.getElementById('editarMotivoCotizacionContainer');
        const editarMotivoCotizacionInput = document.getElementById('editarMotivoCotizacion');

        // Modal para el cupón
        const cuponModalEl = document.getElementById('cuponModal');
        const cuponContent = document.getElementById('cuponContent');

        // Modal de confirmación para eliminar
        const confirmarEliminarModalEl = document.getElementById('confirmarEliminarModal');
        const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
        let citaIdAEliminar = null;

        // Configuración
        const configNombreEmpresa = document.getElementById('configNombreEmpresa');
        const configSucursal = document.getElementById('configSucursal');
        const configDireccion = document.getElementById('configDireccion');
        const configTelefono = document.getElementById('configTelefono');
        const configLogo = document.getElementById('configLogo');
        const logoPreview = document.getElementById('logoPreview');
        const configMoneda = document.getElementById('configMoneda');
        const configFormatoMoneda = document.getElementById('configFormatoMoneda');
        const btnGuardarConfiguracion = document.getElementById('btnGuardarConfiguracion');
        const headerLogo = document.getElementById('headerLogo');
        const headerEmpresaNombre = document.getElementById('headerEmpresaNombre');
        const simboloMoneda = document.getElementById('simboloMoneda');
        const simboloMonedaInput = document.getElementById('simboloMonedaInput');

        // Agente Form
        const agenteIdInput = document.getElementById('agenteId');
        const agenteNombreInput = document.getElementById('agenteNombre');
        const agenteEmailInput = document.getElementById('agenteEmail');
        const agenteTelefonoInput = document.getElementById('agenteTelefono');
        const agenteActivoInput = document.getElementById('agenteActivo');

        // Datos para importación
        let datosImportados = [];
        let agenteSeleccionado = null;

        // Gráficos
        let estadoChart = null;
        let facturacionChart = null;

        // --- Funciones de Utilidad ---
        /**
         * Muestra un mensaje temporal en la pantalla.
         * @param {string} mensaje - El texto del mensaje.
         * @param {string} tipo - El tipo de alerta ('success', 'danger', 'warning', 'info').
         */
        function mostrarMensaje(mensaje, tipo) {
            const mensajeContainer = document.getElementById('mensajeContainer');
            const mensajeAlerta = document.getElementById('mensajeAlerta');
            mensajeAlerta.textContent = mensaje;
            mensajeAlerta.className = `alert alert-${tipo}`;
            mensajeContainer.style.display = 'block';
            setTimeout(() => {
                mensajeContainer.style.display = 'none';
            }, 3000);
        }

        /**
         * Retorna la clase de badge de Bootstrap según el estado.
         * @param {string} estado - El estado de la cita.
         * @returns {string} La clase CSS para el badge.
         */
        function getBadgeClass(estado) {
            switch (estado) {
                case 'pendiente':
                    return 'badge bg-secondary';
                case 'recibido':
                    return 'badge bg-info';
                case 'completada':
                    return 'badge bg-success';
                case 'reagendada':
                    return 'badge bg-warning';
                case 'no_asistio':
                    return 'badge bg-danger';
                case 'cancelada':
                    return 'badge bg-dark';
                default:
                    return 'badge bg-primary';
            }
        }

        /**
         * Retorna los íconos de estado financiero.
         * @param {object} cita - Objeto de la cita.
         * @returns {string} HTML con los íconos.
         */
        function getFinanzasIcons(cita) {
            let icons = '';
            // Ícono de facturación
            const facturadoIcon = cita.facturado
                ? '<i class="fas fa-money-bill-wave text-success finanzas-icon" title="Facturado"></i>'
                : '<i class="fas fa-money-bill-wave text-muted finanzas-icon" title="No facturado"></i>';
            icons += facturadoIcon;

            // Ícono de cotización
            switch (cita.tieneCotizacion) {
                case 'si':
                    icons += '<i class="fas fa-check-circle text-success finanzas-icon" title="Con cotización"></i>';
                    break;
                case 'no':
                    icons += '<i class="fas fa-exclamation-circle text-danger finanzas-icon" title="¡Sin cotización!"></i>';
                    break;
                case 'no_aplica':
                default:
                    icons += '<i class="fas fa-minus-circle text-secondary finanzas-icon" title="No aplica cotización"></i>';
                    break;
            }
            return icons;
        }

        /**
         * Convierte el estado de Excel al formato interno
         * @param {string} estadoExcel - Estado en formato Excel
         * @returns {string} Estado en formato interno
         */
        function convertirEstado(estadoExcel) {
            if (!estadoExcel) return 'pendiente';
            
            const estados = {
                'pendiente': 'pendiente',
                'recibido': 'recibido',
                'completada': 'completada',
                'reagendada': 'reagendada',
                'no asistio': 'no_asistio',
                'no asistió': 'no_asistio',
                'no_asistio': 'no_asistio',
                'cancelada': 'cancelada',
                'facturado': 'completada'
            };
            
            return estados[estadoExcel.toLowerCase()] || 'pendiente';
        }

        /**
         * Convierte la hora de Excel al formato interno
         * @param {string} horaExcel - Hora en formato Excel
         * @returns {string} Hora en formato interno
         */
        function convertirHora(horaExcel) {
            if (!horaExcel) return '08:00';
            
            // Intentar parsear diferentes formatos de hora
            const hora = horaExcel.toString().toLowerCase();
            
            if (hora.includes('8:00') || hora.includes('8:00')) return '08:00';
            if (hora.includes('9:00') || hora.includes('9:00')) return '09:00';
            if (hora.includes('10:00')) return '10:00';
            if (hora.includes('11:00')) return '11:00';
            if (hora.includes('12:00')) return '12:00';
            if (hora.includes('13:00') || hora.includes('1:00')) return '13:00';
            if (hora.includes('14:00') || hora.includes('2:00')) return '14:00';
            if (hora.includes('15:00') || hora.includes('3:00')) return '15:00';
            if (hora.includes('16:00') || hora.includes('4:00')) return '16:00';
            
            return '08:00';
        }

        /**
         * Formatea un monto a formato de dinero según la configuración
         * @param {number} monto - Monto a formatear
         * @returns {string} Monto formateado
         */
        function formatearMonto(monto) {
            if (!monto || isNaN(monto)) {
                switch(configuracion.moneda) {
                    case 'USD': return '$0.00';
                    case 'EUR': return '€0,00';
                    default: return 'RD$0.00';
                }
            }
            
            const opciones = {
                style: 'currency',
                currency: configuracion.moneda === 'RD' ? 'DOP' : configuracion.moneda,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            };
            
            // Para el peso dominicano, forzamos el símbolo RD$
            if (configuracion.moneda === 'RD') {
                opciones.currencyDisplay = 'code';
            }
            
            let valorFormateado = new Intl.NumberFormat(configuracion.formatoMoneda, opciones).format(monto);
            
            // Reemplazar DOP con RD$ para el peso dominicano
            if (configuracion.moneda === 'RD') {
                valorFormateado = valorFormateado.replace('DOP', 'RD$');
            }
            
            return valorFormateado;
        }

        /**
         * Obtiene el símbolo de moneda según la configuración
         * @returns {string} Símbolo de moneda
         */
        function obtenerSimboloMoneda() {
            switch(configuracion.moneda) {
                case 'USD': return '$';
                case 'EUR': return '€';
                default: return 'RD$';
            }
        }

        /**
         * Parsea un monto desde diferentes formatos
         * @param {string} montoStr - String del monto
         * @returns {number} Monto parseado
         */
        function parsearMonto(montoStr) {
            if (!montoStr) return 0;
            
            // Remover caracteres no numéricos excepto punto y coma
            const numeroStr = montoStr.toString().replace(/[^\d,.-]/g, '');
            
            // Reemplazar coma por punto si es necesario
            const numeroNormalizado = numeroStr.replace(',', '.');
            
            // Convertir a número
            const monto = parseFloat(numeroNormalizado);
            
            return isNaN(monto) ? 0 : monto;
        }

        /**
         * Convierte una fecha de Excel a formato JavaScript
         * @param {number} excelDate - Fecha en formato Excel (número de serie)
         * @returns {string} Fecha en formato YYYY-MM-DD
         */
        function convertirFechaExcel(excelDate) {
            // Si es un número de serie de Excel (días desde 1900-01-01)
            if (typeof excelDate === 'number') {
                const fecha = new Date((excelDate - 25569) * 86400 * 1000);
                return fecha.toISOString().split('T')[0];
            }
            
            // Si ya es una cadena, intentar parsearla
            return formatearFecha(excelDate);
        }

        // --- Funciones Principales ---
        /**
         * Carga las citas desde localStorage.
         */
        function cargarCitas() {
            const citasGuardadas = localStorage.getItem('citas');
            citas = citasGuardadas ? JSON.parse(citasGuardadas) : [];
            
            // Cargar agentes
            cargarAgentes();
            
            // Cargar configuración
            cargarConfiguracion();
            
            // Migrar datos antiguos si es necesario
            migrarDatosAntiguos();
            
            // Actualizar resumen
            actualizarResumen();
            
            // Generar reportes
            generarReportes();
            
            // Cargar años en el filtro
            cargarFiltroAnios();
            
            // Cargar agentes en los selects
            cargarAgentesEnSelects();
        }

        /**
         * Carga la configuración desde localStorage
         */
        function cargarConfiguracion() {
            const configGuardada = localStorage.getItem('configuracion');
            if (configGuardada) {
                configuracion = JSON.parse(configGuardada);
                aplicarConfiguracion();
            }
        }

        /**
         * Aplica la configuración cargada a la interfaz
         */
        function aplicarConfiguracion() {
            // Actualizar logo y nombre de empresa
            headerLogo.src = configuracion.logo;
            headerEmpresaNombre.textContent = configuracion.nombreEmpresa;
            
            // Actualizar símbolos de moneda
            const simbolo = obtenerSimboloMoneda();
            simboloMoneda.textContent = simbolo;
            simboloMonedaInput.textContent = simbolo;
            
            // Actualizar formulario de configuración
            if (configNombreEmpresa) {
                configNombreEmpresa.value = configuracion.nombreEmpresa;
                configSucursal.value = configuracion.sucursal;
                configDireccion.value = configuracion.direccion;
                configTelefono.value = configuracion.telefono;
                configMoneda.value = configuracion.moneda;
                configFormatoMoneda.value = configuracion.formatoMoneda;
                logoPreview.src = configuracion.logo;
            }
        }

        /**
         * Guarda la configuración en localStorage
         */
        function guardarConfiguracion() {
            localStorage.setItem('configuracion', JSON.stringify(configuracion));
            aplicarConfiguracion();
            mostrarMensaje("Configuración guardada correctamente.", "success");
        }

        /**
         * Carga los agentes desde localStorage
         */
        function cargarAgentes() {
            const agentesGuardados = localStorage.getItem('agentes');
            agentes = agentesGuardados ? JSON.parse(agentesGuardados) : [
                { id: 1, nombre: "Juan Pérez", email: "juan@checkenginerd.com", telefono: "809-555-0101", activo: true },
                { id: 2, nombre: "María García", email: "maria@checkenginerd.com", telefono: "809-555-0102", activo: true },
                { id: 3, nombre: "Carlos Rodríguez", email: "carlos@checkenginerd.com", telefono: "809-555-0103", activo: true }
            ];
            
            // Renderizar tabla de agentes
            renderAgentes();
        }

        /**
         * Guarda los agentes en localStorage
         */
        function guardarAgentes() {
            localStorage.setItem('agentes', JSON.stringify(agentes));
            renderAgentes();
            cargarAgentesEnSelects();
        }

        /**
         * Renderiza la tabla de agentes
         */
        function renderAgentes() {
            if (!tablaAgentes) return;
            
            tablaAgentes.innerHTML = '';
            
            agentes.forEach(agente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${agente.nombre}</td>
                    <td>${agente.email || 'N/A'}</td>
                    <td>${agente.telefono || 'N/A'}</td>
                    <td><span class="badge ${agente.activo ? 'bg-success' : 'bg-secondary'}">${agente.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarAgente(${agente.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tablaAgentes.appendChild(tr);
            });
        }

        /**
         * Carga los agentes en los selects del formulario
         */
        function cargarAgentesEnSelects() {
            if (!agenteSelect || !editarAgenteInput) return;
            
            // Limpiar selects
            agenteSelect.innerHTML = '';
            editarAgenteInput.innerHTML = '';
            
            // Agregar opción por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Seleccione un agente...';
            agenteSelect.appendChild(defaultOption.cloneNode(true));
            editarAgenteInput.appendChild(defaultOption.cloneNode(true));
            
            // Agregar agentes activos
            agentes.filter(a => a.activo).forEach(agente => {
                const option = document.createElement('option');
                option.value = agente.id;
                option.textContent = agente.nombre;
                agenteSelect.appendChild(option.cloneNode(true));
                editarAgenteInput.appendChild(option.cloneNode(true));
            });
        }

        /**
         * Carga los años disponibles en el filtro
         */
        function cargarFiltroAnios() {
            if (!filtroAnioSelect) return;
            
            // Obtener años únicos de las citas
            const anios = new Set();
            citas.forEach(cita => {
                if (cita.fecha) {
                    const anio = new Date(cita.fecha).getFullYear();
                    anios.add(anio);
                }
            });
            
            // Ordenar años de forma descendente
            const aniosOrdenados = Array.from(anios).sort((a, b) => b - a);
            
            // Limpiar select
            filtroAnioSelect.innerHTML = '<option value="">Todos los años</option>';
            
            // Agregar años
            aniosOrdenados.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                filtroAnioSelect.appendChild(option);
            });
        }

        /**
         * Función para migrar datos antiguos a la nueva estructura
         */
        function migrarDatosAntiguos() {
            let necesitaGuardar = false;
            
            for (let i = 0; i < citas.length; i++) {
                // Si existe el campo 'vehiculo' pero no 'marca', migrar los datos
                if (citas[i].vehiculo && !citas[i].marca) {
                    citas[i].marca = citas[i].vehiculo;
                    delete citas[i].vehiculo;
                    necesitaGuardar = true;
                }
                
                // Si no existe el campo 'modelo', crearlo vacío
                if (!citas[i].hasOwnProperty('modelo')) {
                    citas[i].modelo = "";
                    necesitaGuardar = true;
                }
                
                // Si no existe el campo 'agente', crearlo vacío
                if (!citas[i].hasOwnProperty('agente')) {
                    citas[i].agente = "";
                    necesitaGuardar = true;
                }
                
                // Si no existe el campo 'tieneCotizacion', crearlo con valor por defecto
                if (!citas[i].hasOwnProperty('tieneCotizacion')) {
                    citas[i].tieneCotizacion = "no_aplica";
                    necesitaGuardar = true;
                }
                
                // Si no existe el campo 'motivoCotizacion', crearlo vacío
                if (!citas[i].hasOwnProperty('motivoCotizacion')) {
                    citas[i].motivoCotizacion = "";
                    necesitaGuardar = true;
                }
                
                // Si no existe el campo 'otroServicio', crearlo vacío
                if (!citas[i].hasOwnProperty('otroServicio')) {
                    citas[i].otroServicio = "";
                    necesitaGuardar = true;
                }
            }
            
            if (necesitaGuardar) {
                guardarCitas();
                mostrarMensaje("Datos antiguos migrados correctamente a la nueva estructura.", "info");
            }
        }

        /**
         * Guarda las citas en localStorage.
         */
        function guardarCitas() {
            localStorage.setItem('citas', JSON.stringify(citas));
        }

        /**
         * Renderiza la tabla de citas en el DOM.
         */
        function renderCitas() {
            if (!listaCitas) return;
            
            listaCitas.innerHTML = '';
            
            // Obtener todos los filtros activos
            const estadoFiltro = grupoFiltros.querySelector('.active')?.getAttribute('data-estado') || 'todas';
            const fechaFiltro = filtroFechaInput.value;
            const mesFiltro = filtroMesSelect.value;
            const anioFiltro = filtroAnioSelect.value;
            const facturadoFiltro = filtroFacturadoInput.checked;

            // Filtrar las citas
            const citasFiltradas = citas.filter(cita => {
                const coincideEstado = estadoFiltro === 'todas' || cita.estado === estadoFiltro;
                const coincideFecha = !fechaFiltro || cita.fecha === fechaFiltro;
                
                // Filtrar por mes
                let coincideMes = true;
                if (mesFiltro) {
                    const fechaCita = new Date(cita.fecha);
                    const mesCita = (fechaCita.getMonth() + 1).toString().padStart(2, '0');
                    coincideMes = mesCita === mesFiltro;
                }
                
                // Filtrar por año
                let coincideAnio = true;
                if (anioFiltro) {
                    const fechaCita = new Date(cita.fecha);
                    const anioCita = fechaCita.getFullYear().toString();
                    coincideAnio = anioCita === anioFiltro;
                }
                
                const coincideFacturado = !facturadoFiltro || cita.facturado;
                return coincideEstado && coincideFecha && coincideMes && coincideAnio && coincideFacturado;
            });
            
            citasFiltradas.forEach(cita => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-estado-cita', cita.estado);
                tr.setAttribute('data-fecha-cita', cita.fecha);
                
                // Obtener nombre del agente
                const agente = agentes.find(a => a.id == cita.agente) || { nombre: 'N/A' };
                
                tr.innerHTML = `
                    <td>${formatearFechaParaVisualizacion(cita.fecha)} <br><span class="text-muted">${cita.hora}</span></td>
                    <td>${cita.nombreCliente} <br><span class="text-muted">${cita.telefono}</span></td>
                    <td>${cita.marca}</td>
                    <td>${cita.modelo}</td>
                    <td>${cita.anio}</td>
                    <td>${agente.nombre}</td>
                    <td>
                        <span class="${getBadgeClass(cita.estado)}">${cita.estado.charAt(0).toUpperCase() + cita.estado.slice(1).replace('_', ' ')}</span>
                    </td>
                    <td>
                        ${getFinanzasIcons(cita)}
                        ${cita.facturado ? `<div class="text-small">${formatearMonto(cita.monto)}</div>` : ''}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-warning btn-action" onclick="abrirEditarModal(${cita.id})" title="Editar cita">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-info btn-action" onclick="abrirCuponModal(${cita.id})" title="Ver cupón">
                                <i class="fas fa-ticket-alt"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-action" onclick="abrirConfirmacionEliminar(${cita.id})" title="Eliminar cita">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                listaCitas.appendChild(tr);
            });

            // Recalcular las estadísticas basadas en el conjunto filtrado
            calcularEstadisticas(citasFiltradas);
            
            // Actualizar resumen
            actualizarResumen();
            
            // Generar reportes
            generarReportes();
        }

        /**
         * Actualiza el panel de resumen
         */
        function actualizarResumen() {
            const hoy = new Date().toISOString().split('T')[0];
            
            const totalCitas = citas.length;
            const citasHoy = citas.filter(c => c.fecha === hoy).length;
            const citasPendientes = citas.filter(c => c.estado === 'pendiente').length;
            const montoTotal = citas.filter(c => c.facturado).reduce((sum, c) => sum + (c.monto || 0), 0);
            
            if (document.getElementById('resumenTotal')) {
                document.getElementById('resumenTotal').textContent = totalCitas;
                document.getElementById('resumenHoy').textContent = citasHoy;
                document.getElementById('resumenPendientes').textContent = citasPendientes;
                document.getElementById('resumenFacturado').textContent = formatearMonto(montoTotal);
            }
        }

        /**
         * Genera reportes y gráficos
         */
        function generarReportes() {
            // Generar gráfico de estados
            generarGraficoEstados();
            
            // Generar gráfico de facturación mensual
            generarGraficoFacturacion();
            
            // Generar tabla de reportes por agente
            generarTablaReportes();
        }

        /**
         * Genera el gráfico de distribución por estado
         */
        function generarGraficoEstados() {
            const ctx = document.getElementById('estadoChart');
            if (!ctx) return;
            
            const estados = ['pendiente', 'recibido', 'completada', 'reagendada', 'no_asistio', 'cancelada'];
            const conteoEstados = {};
            
            estados.forEach(estado => {
                conteoEstados[estado] = citas.filter(c => c.estado === estado).length;
            });
            
            // Destruir gráfico anterior si existe
            if (estadoChart) {
                estadoChart.destroy();
            }
            
            estadoChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pendientes', 'Recibidos', 'Completadas', 'Reagendadas', 'No Asistieron', 'Canceladas'],
                    datasets: [{
                        data: Object.values(conteoEstados),
                        backgroundColor: [
                            '#6c757d', // pendiente - gris
                            '#17a2b8', // recibido - azul claro
                            '#28a745', // completada - verde
                            '#ffc107', // reagendada - amarillo
                            '#dc3545', // no_asistio - rojo
                            '#343a40'  // cancelada - negro
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Citas por Estado'
                        }
                    }
                }
            });
        }

        /**
         * Genera el gráfico de facturación mensual
         */
        function generarGraficoFacturacion() {
            const ctx = document.getElementById('facturacionChart');
            if (!ctx) return;
            
            // Agrupar facturación por mes
            const facturacionMensual = {};
            
            citas.filter(c => c.facturado).forEach(cita => {
                const fecha = new Date(cita.fecha);
                const mes = fecha.getMonth() + 1;
                const año = fecha.getFullYear();
                const clave = `${año}-${mes.toString().padStart(2, '0')}`;
                
                if (!facturacionMensual[clave]) {
                    facturacionMensual[clave] = 0;
                }
                
                facturacionMensual[clave] += cita.monto || 0;
            });
            
            // Ordenar por fecha
            const mesesOrdenados = Object.keys(facturacionMensual).sort();
            const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const etiquetas = mesesOrdenados.map(clave => {
                const partes = clave.split('-');
                return `${nombresMeses[parseInt(partes[1]) - 1]} ${partes[0]}`;
            });
            
            const valores = mesesOrdenados.map(clave => facturacionMensual[clave]);
            
            // Destruir gráfico anterior si existe
            if (facturacionChart) {
                facturacionChart.destroy();
            }
            
            facturacionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: etiquetas,
                    datasets: [{
                        label: 'Facturación Mensual',
                        data: valores,
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Facturación Mensual'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatearMonto(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Genera la tabla de reportes por agente
         */
        function generarTablaReportes() {
            const tablaReportes = document.getElementById('tablaReportes');
            if (!tablaReportes) return;
            
            tablaReportes.innerHTML = '';
            
            // Agrupar citas por agente
            const reportesAgentes = {};
            
            agentes.forEach(agente => {
                reportesAgentes[agente.id] = {
                    nombre: agente.nombre,
                    total: 0,
                    completadas: 0,
                    facturado: 0
                };
            });
            
            citas.forEach(cita => {
                if (cita.agente && reportesAgentes[cita.agente]) {
                    reportesAgentes[cita.agente].total++;
                    
                    if (cita.estado === 'completada') {
                        reportesAgentes[cita.agente].completadas++;
                    }
                    
                    if (cita.facturado) {
                        reportesAgentes[cita.agente].facturado += cita.monto || 0;
                    }
                }
            });
            
            // Generar filas de la tabla
            for (const [agenteId, datos] of Object.entries(reportesAgentes)) {
                const efectividad = datos.total > 0 ? (datos.completadas / datos.total) * 100 : 0;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${datos.nombre}</td>
                    <td>${datos.total}</td>
                    <td>${datos.completadas}</td>
                    <td>${formatearMonto(datos.facturado)}</td>
                    <td>${efectividad.toFixed(1)}%</td>
                `;
                tablaReportes.appendChild(tr);
            }
        }

        /**
         * Formatea una fecha para visualización (DD/MM/YYYY)
         * @param {string} fechaStr - Fecha en formato YYYY-MM-DD
         * @returns {string} Fecha formateada
         */
        function formatearFechaParaVisualizacion(fechaStr) {
            if (!fechaStr) return '';
            
            try {
                const partes = fechaStr.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
                return fechaStr;
            } catch (e) {
                return fechaStr;
            }
        }

        /**
         * Formatea una fecha desde varios formatos posibles a YYYY-MM-DD
         * @param {string} fechaStr - Fecha en formato string
         * @returns {string} Fecha en formato YYYY-MM-DD
         */
        function formatearFecha(fechaStr) {
            if (!fechaStr) return new Date().toISOString().split('T')[0];
            
            try {
                // Probar formato DD/MM/YYYY
                if (fechaStr.includes('/')) {
                    const partes = fechaStr.split('/');
                    if (partes.length === 3) {
                        const day = partes[0].padStart(2, '0');
                        const month = partes[1].padStart(2, '0');
                        const year = partes[2];
                        return `${year}-${month}-${day}`;
                    }
                }
                
                // Probar formato MM/DD/YYYY
                if (fechaStr.includes('-')) {
                    const partes = fechaStr.split('-');
                    if (partes.length === 3) {
                        const day = partes[2].padStart(2, '0');
                        const month = partes[1].padStart(2, '0');
                        const year = partes[0];
                        return `${year}-${month}-${day}`;
                    }
                }
                
                // Intentar parsear como fecha
                const fecha = new Date(fechaStr);
                if (!isNaN(fecha.getTime())) {
                    return fecha.toISOString().split('T')[0];
                }
            } catch (e) {
                console.error("Error formateando fecha:", e);
            }
            
            return new Date().toISOString().split('T')[0];
        }

        /**
         * Agrega una nueva cita desde el formulario.
         * @param {Event} event - El evento de envío del formulario.
         */
        function agregarCita(event) {
            event.preventDefault();
            const nuevoId = citas.length > 0 ? Math.max(...citas.map(c => c.id)) + 1 : 1;
            const servicio = servicioSelect.value;
            const nuevoServicio = servicio === 'Otro' ? otroServicioInput.value : servicio;

            const nuevaCita = {
                id: nuevoId,
                nombreCliente: document.getElementById('nombreCliente').value,
                telefono: document.getElementById('telefono').value,
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                anio: parseInt(document.getElementById('anio').value),
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                servicio: nuevoServicio,
                notas: document.getElementById('notas').value,
                agente: document.getElementById('agente').value,
                estado: "pendiente",
                facturado: false,
                monto: 0,
                tieneCotizacion: "no_aplica",
                motivoCotizacion: "",
                otroServicio: servicio === 'Otro' ? otroServicioInput.value : ""
            };

            citas.push(nuevaCita);
            guardarCitas();
            renderCitas();
            citaForm.reset();
            mostrarMensaje("Cita agregada con éxito.", "success");
            
            // Cambiar a la pestaña de gestión de citas
            document.getElementById('pills-citas-tab').click();
        }

        /**
         * Abre el modal de confirmación para eliminar una cita.
         * @param {number} id - El ID de la cita a eliminar.
         */
        function abrirConfirmacionEliminar(id) {
            citaIdAEliminar = id;
            const confirmarEliminarModal = new bootstrap.Modal(confirmarEliminarModalEl);
            confirmarEliminarModal.show();
        }

        /**
         * Elimina una cita de la lista.
         */
        function eliminarCita() {
            if (citaIdAEliminar !== null) {
                citas = citas.filter(cita => cita.id !== citaIdAEliminar);
                guardarCitas();
                renderCitas();
                mostrarMensaje("Cita eliminada correctamente.", "danger");
                bootstrap.Modal.getInstance(confirmarEliminarModalEl).hide();
                citaIdAEliminar = null;
            }
        }

        /**
         * Abre el modal de edición con los datos de una cita.
         * @param {number} id - El ID de la cita a editar.
         */
        function abrirEditarModal(id) {
            const cita = citas.find(c => c.id === id);
            if (cita) {
                editarIdInput.value = cita.id;
                editarNombreClienteInput.value = cita.nombreCliente;
                editarTelefonoInput.value = cita.telefono;
                editarMarcaInput.value = cita.marca;
                editarModeloInput.value = cita.modelo;
                editarAnioInput.value = cita.anio;
                editarFechaInput.value = cita.fecha;
                editarHoraInput.value = cita.hora;
                editarServicioSelect.value = cita.servicio === "Otro" ? "Otro" : cita.servicio;
                if (cita.servicio === "Otro") {
                    editarOtroServicioContainer.style.display = '';
                    editarOtroServicioInput.value = cita.otroServicio || '';
                } else {
                    editarOtroServicioContainer.style.display = 'none';
                    editarOtroServicioInput.value = '';
                }
                editarNotasInput.value = cita.notas;
                editarAgenteInput.value = cita.agente || '';
                editarEstadoSelect.value = cita.estado;
                editarFacturadoInput.checked = cita.facturado;
                editarMontoInput.value = cita.facturado ? cita.monto : '';
                editarTieneCotizacionSelect.value = cita.tieneCotizacion;
                if (cita.tieneCotizacion === "no") {
                    editarMotivoCotizacionContainer.style.display = '';
                    editarMotivoCotizacionInput.value = cita.motivoCotizacion || '';
                } else {
                    editarMotivoCotizacionContainer.style.display = 'none';
                    editarMotivoCotizacionInput.value = '';
                }

                const editarCitaModal = new bootstrap.Modal(editarCitaModalEl);
                editarCitaModal.show();
            }
        }

        /**
         * Guarda los cambios de una cita editada.
         */
        function guardarEdicion() {
            const id = parseInt(editarIdInput.value);
            const index = citas.findIndex(c => c.id === id);
            if (index !== -1) {
                const servicio = editarServicioSelect.value;
                const nuevoServicio = servicio === 'Otro' ? editarOtroServicioInput.value : servicio;
                const tieneCotizacion = editarTieneCotizacionSelect.value;
                const motivoCotizacion = tieneCotizacion === "no" ? editarMotivoCotizacionInput.value : "";

                citas[index] = {
                    id: id,
                    nombreCliente: editarNombreClienteInput.value,
                    telefono: editarTelefonoInput.value,
                    marca: editarMarcaInput.value,
                    modelo: editarModeloInput.value,
                    anio: parseInt(editarAnioInput.value),
                    fecha: editarFechaInput.value,
                    hora: editarHoraInput.value,
                    servicio: nuevoServicio,
                    otroServicio: servicio === 'Otro' ? editarOtroServicioInput.value : "",
                    notas: editarNotasInput.value,
                    agente: editarAgenteInput.value,
                    estado: editarEstadoSelect.value,
                    facturado: editarFacturadoInput.checked,
                    monto: editarFacturadoInput.checked ? parsearMonto(editarMontoInput.value) : 0,
                    tieneCotizacion: tieneCotizacion,
                    motivoCotizacion: motivoCotizacion
                };
                guardarCitas();
                renderCitas();
                bootstrap.Modal.getInstance(editarCitaModalEl).hide();
                mostrarMensaje("Cita editada con éxito.", "warning");
            }
        }

        /**
         * Abre el modal para ver e imprimir el cupón.
         * @param {number} id - El ID de la cita para el cupón.
         */
        function abrirCuponModal(id) {
            const cita = citas.find(c => c.id === id);
            if (cita) {
                const servicio = cita.servicio === 'Otro' ? cita.otroServicio : cita.servicio;
                // Obtener nombre del agente
                const agente = agentes.find(a => a.id == cita.agente) || { nombre: 'N/A' };
                
                cuponContent.innerHTML = `
                    <div class="card border-0">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <img src="${configuracion.logo}" class="logo mb-2">
                                <h2 class="text-primary fw-bold">Cupón de Servicio</h2>
                                <p class="text-muted">${configuracion.nombreEmpresa} - ${configuracion.sucursal}</p>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Cliente:</strong> ${cita.nombreCliente}</p>
                                    <p><strong>Teléfono:</strong> ${cita.telefono}</p>
                                    <p><strong>Vehículo:</strong> ${cita.marca} ${cita.modelo} ${cita.anio}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Fecha:</strong> ${formatearFechaParaVisualizacion(cita.fecha)}</p>
                                    <p><strong>Hora:</strong> ${cita.hora}</p>
                                    <p><strong>Servicio:</strong> ${servicio}</p>
                                    <p><strong>Agente:</strong> ${agente.nombre}</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h5>Notas:</h5>
                                <p>${cita.notas || 'N/A'}</p>
                            </div>
                            <hr>
                            <p class="text-center text-muted">Este cupón es válido para el día y la hora pautados para su cita de chequeo de vehículo. No se permite la reventa del mismo.

Ubicación: ${configuracion.direccion}
¡Gracias por preferir nuestros servicios!</p>
                        </div>
                    </div>
                `;
                const cuponModal = new bootstrap.Modal(cuponModalEl);
                cuponModal.show();
            }
        }

        /**
         * Imprime el contenido del cupón.
         */
        function imprimirCupon() {
            const contenido = cuponContent.innerHTML;
            const ventanaImpresion = window.open('', '', 'height=600,width=800');
            ventanaImpresion.document.write('<html><head><title>Cupón de Servicio</title>');
            ventanaImpresion.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            ventanaImpresion.document.write('</head><body>');
            ventanaImpresion.document.write(contenido);
            ventanaImpresion.document.write('</body></html>');
            ventanaImpresion.document.close();
            ventanaImpresion.onload = function() {
                ventanaImpresion.print();
            };
        }

        /**
         * Genera un texto copiable con las citas del día agrupadas por agente
         */
        function generarTextoParaCopiar() {
            // Obtener la fecha seleccionada en el filtro o usar la de hoy
            const fechaFiltro = filtroFechaInput.value;
            let fechaParaMostrar = 'mañana';
            
            if (fechaFiltro) {
                const fecha = new Date(fechaFiltro);
                fechaParaMostrar = fecha.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            // Obtener citas filtradas
            const estadoFiltro = grupoFiltros.querySelector('.active')?.getAttribute('data-estado') || 'todas';
            const mesFiltro = filtroMesSelect.value;
            const anioFiltro = filtroAnioSelect.value;
            const facturadoFiltro = filtroFacturadoInput.checked;

            const citasFiltradas = citas.filter(cita => {
                const coincideEstado = estadoFiltro === 'todas' || cita.estado === estadoFiltro;
                const coincideFecha = !fechaFiltro || cita.fecha === fechaFiltro;
                
                let coincideMes = true;
                if (mesFiltro) {
                    const fechaCita = new Date(cita.fecha);
                    const mesCita = (fechaCita.getMonth() + 1).toString().padStart(2, '0');
                    coincideMes = mesCita === mesFiltro;
                }
                
                let coincideAnio = true;
                if (anioFiltro) {
                    const fechaCita = new Date(cita.fecha);
                    const anioCita = fechaCita.getFullYear().toString();
                    coincideAnio = anioCita === anioFiltro;
                }
                
                const coincideFacturado = !facturadoFiltro || cita.facturado;
                return coincideEstado && coincideFecha && coincideMes && coincideAnio && coincideFacturado;
            });
            
            // Agrupar por agente
            const citasPorAgente = {};
            citasFiltradas.forEach(cita => {
                const agenteId = cita.agente || 'sin-asignar';
                const agente = agentes.find(a => a.id == agenteId) || { nombre: 'Sin asignar' };
                
                if (!citasPorAgente[agente.nombre]) {
                    citasPorAgente[agente.nombre] = [];
                }
                citasPorAgente[agente.nombre].push(cita);
            });
            
            // Generar texto
            let texto = `Proyección para ${fechaParaMostrar}\n\n`;
            
            for (const [agente, citasAgente] of Object.entries(citasPorAgente)) {
                texto += `*${configuracion.nombreEmpresa} / ${agente}*\n`;
                
                citasAgente.forEach(cita => {
                    texto += `- ${cita.marca} ${cita.modelo} ${cita.anio}\n`;
                });
                
                texto += '\n';
            }
            
            return texto;
        }

        /**
         * Copia el texto al portapapeles
         * @param {string} texto - Texto a copiar
         */
        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                mostrarMensaje("Lista copiada al portapapeles", "success");
            }).catch(err => {
                console.error('Error al copiar: ', err);
                // Fallback para navegadores más antiguos
                const textArea = document.createElement('textarea');
                textArea.value = texto;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    mostrarMensaje("Lista copiada al portapapeles", "success");
                } catch (e) {
                    mostrarMensaje("Error al copiar al portapapeles", "danger");
                }
                document.body.removeChild(textArea);
            });
        }

        /**
         * Muestra el modal para seleccionar agente
         */
        function mostrarModalAgentes() {
            listaAgentes.innerHTML = '';
            
            // Filtrar agentes si hay texto de búsqueda
            const filtro = filtroAgente.value.toLowerCase();
            const agentesFiltrados = filtro 
                ? agentes.filter(agente => agente.nombre.toLowerCase().includes(filtro))
                : agentes;
            
            if (agentesFiltrados.length === 0) {
                listaAgentes.innerHTML = '<div class="list-group-item text-center">No hay agentes disponibles</div>';
                return;
            }
            
            agentesFiltrados.forEach(agente => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action agente-item';
                item.textContent = agente.nombre;
                item.addEventListener('click', () => {
                    // Deseleccionar cualquier item previamente seleccionado
                    document.querySelectorAll('.agente-item').forEach(i => i.classList.remove('active'));
                    // Seleccionar este item
                    item.classList.add('active');
                    agenteSeleccionado = agente;
                });
                listaAgentes.appendChild(item);
            });
            
            seleccionarAgenteModal.show();
        }

        /**
         * Procesa un archivo Excel/CSV y extrae los datos
         * @param {File} file - Archivo a procesar
         */
        function procesarArchivoExcel(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obtener la primera hoja
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convertir a JSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        mostrarMensaje("El archivo no contiene datos válidos.", "danger");
                        return;
                    }
                    
                    // Obtener encabezados
                    const headers = jsonData[0].map(h => h ? h.toString().toLowerCase().trim() : '');
                    
                    // Procesar filas de datos
                    datosImportados = [];
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        const nombre = row[headers.indexOf('nombre')] || '';
                        const telefono = row[headers.indexOf('whatsapp')] || row[headers.indexOf('teléfono')] || '';
                        const marca = row[headers.indexOf('marca')] || '';
                        const modelo = row[headers.indexOf('modelo')] || '';
                        const anio = row[headers.indexOf('año')] || row[headers.indexOf('ano')] || '';
                        let fecha = row[headers.indexOf('cita')] || '';
                        const hora = row[headers.indexOf('hora')] || '08:00 a. m.';
                        const servicio = row[headers.indexOf('función')] || row[headers.indexOf('servicio')] || '';
                        const estado = row[headers.indexOf('estado')] || '';
                        const notas = row[headers.indexOf('notas')] || row[headers.indexOf('observaciones')] || '';
                        const facturado = row[headers.indexOf('facturación')] || '';
                        const monto = row[headers.indexOf('monto')] || row[headers.indexOf('monto3')] || 0;
                        const agente = row[headers.indexOf('agente')] || '';
                        
                        // Solo procesar filas con datos básicos
                        if (nombre && telefono) {
                            // Corregir formato de fecha si está habilitado
                            if (document.getElementById('corregirFechas').checked) {
                                fecha = convertirFechaExcel(fecha);
                            } else {
                                fecha = formatearFecha(fecha);
                            }
                            
                            datosImportados.push({
                                nombre,
                                telefono: telefono.toString(),
                                marca: marca.toString(),
                                modelo: modelo.toString(),
                                anio: anio.toString(),
                                fecha: fecha,
                                hora: convertirHora(hora),
                                servicio,
                                estado: convertirEstado(estado),
                                notas,
                                agente,
                                facturado: facturado.toString().toLowerCase().includes('facturado'),
                                monto: parsearMonto(monto)
                            });
                        }
                    }
                    
                    // Mostrar vista previa
                    mostrarVistaPrevia();
                    
                } catch (error) {
                    console.error("Error al procesar el archivo:", error);
                    mostrarMensaje("Error al procesar el archivo. Asegúrate de que es un formato válido.", "danger");
                }
            };
            
            reader.onerror = function() {
                mostrarMensaje("Error al leer el archivo.", "danger");
            };
            
            reader.readAsArrayBuffer(file);
        }

        /**
         * Muestra una vista previa de los datos importados
         */
        function mostrarVistaPrevia() {
            vistaPreviaDatos.innerHTML = '';
            
            if (datosImportados.length === 0) {
                vistaPreviaDatos.innerHTML = '<tr><td colspan="9" class="text-center">No hay datos válidos para importar</td></tr>';
                return;
            }
            
            // Mostrar máximo 10 registros en la vista previa
            const previewData = datosImportados.slice(0, 10);
            
            previewData.forEach(dato => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dato.nombre}</td>
                    <td>${dato.telefono}</td>
                    <td>${dato.marca}</td>
                    <td>${dato.modelo}</td>
                    <td>${dato.anio}</td>
                    <td>${formatearFechaParaVisualizacion(dato.fecha)}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.servicio}</td>
                    <td><span class="badge ${getBadgeClass(dato.estado)}">${dato.estado}</span></td>
                `;
                vistaPreviaDatos.appendChild(tr);
            });
            
            if (datosImportados.length > 10) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="9" class="text-center">... y ${datosImportados.length - 10} registros más</td>`;
                vistaPreviaDatos.appendChild(tr);
            }
        }

        /**
         * Confirma la importación de datos desde Excel
         */
        function confirmarImportacion() {
            if (datosImportados.length === 0) {
                mostrarMensaje("No hay datos para importar.", "warning");
                return;
            }
            
            const sobrescribir = document.getElementById('sobrescribirDatos').checked;
            
            if (sobrescribir) {
                citas = [];
            }
            
            // Agregar los datos importados
            let contador = 0;
            const nuevoId = citas.length > 0 ? Math.max(...citas.map(c => c.id)) + 1 : 1;
            
            datosImportados.forEach((dato, index) => {
                const id = nuevoId + index;
                
                // Buscar si el agente existe
                let agenteId = '';
                if (dato.agente) {
                    const agenteExistente = agentes.find(a => a.nombre.toLowerCase() === dato.agente.toLowerCase());
                    if (agenteExistente) {
                        agenteId = agenteExistente.id;
                    } else {
                        // Crear un nuevo agente
                        const nuevoAgenteId = agentes.length > 0 ? Math.max(...agentes.map(a => a.id)) + 1 : 1;
                        agentes.push({
                            id: nuevoAgenteId,
                            nombre: dato.agente,
                            email: '',
                            telefono: '',
                            activo: true
                        });
                        agenteId = nuevoAgenteId;
                    }
                }
                
                citas.push({
                    id: id,
                    nombreCliente: dato.nombre,
                    telefono: dato.telefono,
                    marca: dato.marca,
                    modelo: dato.modelo,
                    anio: dato.anio,
                    fecha: dato.fecha,
                    hora: dato.hora,
                    servicio: dato.servicio,
                    notas: dato.notas,
                    agente: agenteId,
                    estado: dato.estado,
                    facturado: dato.facturado,
                    monto: dato.monto,
                    tieneCotizacion: "no_aplica",
                    motivoCotizacion: "",
                    otroServicio: ""
                });
                
                contador++;
            });
            
            guardarCitas();
            guardarAgentes();
            renderCitas();
            importarExcelModal.hide();
            mostrarMensaje(`Se importaron ${contador} citas correctamente.`, "success");
        }

        /**
         * Exporta los datos de la tabla a un archivo CSV (Excel) con el formato solicitado,
         * incluyendo la codificación correcta y los saltos de línea entre citas.
         */
        function exportarAExcel() {
            // Añadir el Byte Order Mark (BOM) para asegurar la compatibilidad con tildes y ñ en Excel.
            let csv = "\ufeff";

            // Cabeceras solicitadas en el formato de la imagen
            const headers = "Monto,Observaciones,Nombre,Correo,Whatsapp,Marca,Modelo,Trim,Región,Año,Cita,Combustible,Sucursal,Función,Estado,Facturación,Monto,Agente";
            csv += headers + "\n";

            citas.forEach(cita => {
                const servicio = cita.servicio === 'Otro' ? cita.otroServicio : cita.servicio;
                // Obtener nombre del agente
                const agente = agentes.find(a => a.id == cita.agente) || { nombre: '' };
                
                // Los campos no disponibles se marcan como "N/A"
                csv += `"${cita.facturado ? formatearMonto(cita.monto).replace('RD$', '').replace('$', '').replace('€', '').trim() : 'N/A'}",` + // Primer "Monto" de la imagen
                       `"${(cita.notas || '').replace(/"/g, '""')}",` + // Observaciones, escapando comillas
                       `"${(cita.nombreCliente || '').replace(/"/g, '""')}",` + // Nombre, escapando comillas
                       `"N/A",` + // Correo
                       `"${(cita.telefono || '').replace(/"/g, '""')}",` + // Whatsapp, escapando comillas
                       `"${(cita.marca || '').replace(/"/g, '""')}",` +      
                       `"${(cita.modelo || '').replace(/"/g, '""')}",` + // Modelo, escapando comillas
                       `"N/A",` + // Trim
                       `"N/A",` + // Región
                       `"${cita.anio}",` + // Año
                       `"${formatearFechaParaVisualizacion(cita.fecha)} ${cita.hora}",` + // Cita
                       `"N/A",` + // Combustible
                       `"${configuracion.sucursal}",` + // Sucursal
                       `"${(servicio || '').replace(/"/g, '""')}",` + // Función, escapando comillas
                       `"${cita.estado.replace('_', ' ')}",` + // Estado
                       `"${cita.facturado ? 'Sí' : 'No'}",` + // Facturación
                       `"${cita.facturado ? formatearMonto(cita.monto).replace('RD$', '').replace('$', '').replace('€', '').trim() : '0'}",` + // Monto
                       `"${agente.nombre || ''}"` + // Agente
                       `\n`; // Fin de la fila de datos

                // Añadir una fila vacía para el "salto" solicitado
        
            });

            const blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8;'
            });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "citas_checkengine.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Guarda las citas actuales en un archivo JSON para respaldo.
         */
        function guardarManual() {
            const dataStr = JSON.stringify(citas, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "citas_backup.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarMensaje("Respaldo guardado con éxito.", "success");
        }

        function importarDatos(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        citas = importedData;
                        // Migrar datos antiguos después de importar
                        migrarDatosAntiguos();
                        guardarCitas();
                        renderCitas();
                        mostrarMensaje("Datos importados correctamente.","info");
                    } else {
                        mostrarMensaje("El archivo no contiene un formato de datos válido.","danger");
                    }
                } catch (error) {
                    mostrarMensaje("Error al procesar el archivo. Asegúrate de que es un archivo JSON válido.","danger");
                }
            };
            reader.readAsText(file);
            // Limpiar el input para permitir re-importar el mismo archivo
            event.target.value = '';
        }

        function calcularEstadisticas(citasFiltradas) {
            const totalCitas = citasFiltradas.length;
            const recibidas = citasFiltradas.filter(c => c.estado === 'recibido' || c.estado === 'completada').length;
            const facturadas = citasFiltradas.filter(c => c.facturado).length;
            const montoTotal = citasFiltradas.filter(c => c.facturado).reduce((sum, c) => sum + (c.monto || 0), 0);
            const efectividad = totalCitas > 0 ? (recibidas / totalCitas) * 100 : 0;

            document.getElementById('statsTotal').textContent = totalCitas;
            document.getElementById('statsRecibidas').textContent = recibidas;
            document.getElementById('statsMonto').textContent = formatearMonto(montoTotal);
            document.getElementById('statsEfectividad').textContent = `${efectividad.toFixed(0)}%`;
        }

        /**
         * Restablece los filtros de estado de cita.
         */
        function resetearFiltrosEstado() {
            grupoFiltros.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            grupoFiltros.querySelector('[data-estado="todas"]').classList.add('active');
        }

        /**
         * Guarda un agente nuevo o editado
         */
        function guardarAgente() {
            const id = agenteIdInput.value ? parseInt(agenteIdInput.value) : (agentes.length > 0 ? Math.max(...agentes.map(a => a.id)) + 1 : 1);
            const nombre = agenteNombreInput.value;
            const email = agenteEmailInput.value;
            const telefono = agenteTelefonoInput.value;
            const activo = agenteActivoInput.checked;
            
            if (!nombre) {
                mostrarMensaje("El nombre del agente es obligatorio.", "warning");
                return;
            }
            
            if (agenteIdInput.value) {
                // Editar agente existente
                const index = agentes.findIndex(a => a.id === id);
                if (index !== -1) {
                    agentes[index] = {
                        id: id,
                        nombre: nombre,
                        email: email,
                        telefono: telefono,
                        activo: activo
                    };
                }
            } else {
                // Agregar nuevo agente
                agentes.push({
                    id: id,
                    nombre: nombre,
                    email: email,
                    telefono: telefono,
                    activo: activo
                });
            }
            
            guardarAgentes();
            gestionAgentesModal.hide();
            mostrarMensaje(`Agente ${agenteIdInput.value ? 'actualizado' : 'agregado'} correctamente.`, "success");
        }

        /**
         * Edita un agente existente
         * @param {number} id - ID del agente a editar
         */
        function editarAgente(id) {
            const agente = agentes.find(a => a.id === id);
            if (agente) {
                agenteIdInput.value = agente.id;
                agenteNombreInput.value = agente.nombre;
                agenteEmailInput.value = agente.email || '';
                agenteTelefonoInput.value = agente.telefono || '';
                agenteActivoInput.checked = agente.activo;
                
                // Mostrar botón de eliminar
                btnEliminarAgente.style.display = 'block';
                
                gestionAgentesModal.show();
            }
        }

        /**
         * Elimina el agente actualmente en edición
         */
        function eliminarAgente() {
            const id = parseInt(agenteIdInput.value);
            if (id && confirm("¿Estás seguro de que quieres eliminar este agente?")) {
                agentes = agentes.filter(a => a.id !== id);
                guardarAgentes();
                gestionAgentesModal.hide();
                mostrarMensaje("Agente eliminado correctamente.", "success");
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarCitas();
            renderCitas();
            
            // Establece la fecha actual por defecto en el filtro
            const today = new Date().toISOString().split('T')[0];
            // filtroFechaInput.value = today;
            // Descomentar la línea de arriba para que el filtro por día esté activo por defecto.
        });

        // Manejar el formulario de nueva cita
        citaForm.addEventListener('submit', agregarCita);

        // Manejar el cambio en el select de servicio para mostrar/ocultar el campo "Otro"
        servicioSelect.addEventListener('change', () => {
            if (servicioSelect.value === 'Otro') {
                otroServicioContainer.style.display = '';
            } else {
                otroServicioContainer.style.display = 'none';
            }
        });

        // Manejar los clics en los botones de filtro
        grupoFiltros.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON') {
                // Remover la clase 'active' de todos los botones y agregarla al presionado
                grupoFiltros.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                
                // Limpiar otros filtros cuando se usa este
                filtroFechaInput.value = '';
                filtroMesSelect.value = '';
                filtroAnioSelect.value = '';
                filtroFacturadoInput.checked = false;

                renderCitas();
            }
        });

        // Manejar el botón de exportar a Excel
        btnExportarExcel.addEventListener('click', exportarAExcel);

        // Manejar el botón de guardar manual
        btnGuardarManual.addEventListener('click', guardarManual);

        // Manejar el botón de importar desde Excel
        btnImportarExcel.addEventListener('click', () => {
            importarExcelModal.show();
        });

        // Manejar la selección de archivo Excel
        archivoExcelInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                procesarArchivoExcel(e.target.files[0]);
            }
        });

        // Manejar la confirmación de importación
        btnConfirmarImportacion.addEventListener('click', confirmarImportacion);

        // Manejar el input de archivo para importar JSON
        importarArchivoInput.addEventListener('change', importarDatos);

        // Manejar el botón de copiar lista
        btnCopiarLista.addEventListener('click', () => {
            const texto = generarTextoParaCopiar();
            copiarAlPortapapeles(texto);
        });

        // Manejar la edición del servicio en el modal
        editarServicioSelect.addEventListener('change', () => {
            if (editarServicioSelect.value === 'Otro') {
                editarOtroServicioContainer.style.display = '';
            } else {
                editarOtroServicioContainer.style.display = 'none';
            }
        });
        
        // Manejar el cambio en el select de cotización para mostrar/ocultar el motivo
        editarTieneCotizacionSelect.addEventListener('change', () => {
            if (editarTieneCotizacionSelect.value === 'no') {
                editarMotivoCotizacionContainer.style.display = '';
            } else {
                editarMotivoCotizacionContainer.style.display = 'none';
            }
        });

        // Manejar el botón de guardar edición en el modal
        btnGuardarEdicion.addEventListener('click', guardarEdicion);

        // Manejar el botón de confirmar eliminación en el modal
        btnConfirmarEliminar.addEventListener('click', eliminarCita);

        // Manejar el cambio en el input de fecha para las estadísticas
        filtroFechaInput.addEventListener('change', () => {
            // Desactiva otros filtros
            filtroMesSelect.value = '';
            filtroAnioSelect.value = '';
            filtroFacturadoInput.checked = false;
            resetearFiltrosEstado();
            renderCitas();
        });

        // Manejar el cambio en el select de mes
        filtroMesSelect.addEventListener('change', () => {
            // Desactiva otros filtros
            filtroFechaInput.value = '';
            filtroAnioSelect.value = '';
            filtroFacturadoInput.checked = false;
            resetearFiltrosEstado();
            renderCitas();
        });

        // Manejar el cambio en el select de año
        filtroAnioSelect.addEventListener('change', () => {
            // Desactiva otros filtros
            filtroFechaInput.value = '';
            filtroMesSelect.value = '';
            filtroFacturadoInput.checked = false;
            resetearFiltrosEstado();
            renderCitas();
        });

        // Manejar el cambio en el switch de facturado
        filtroFacturadoInput.addEventListener('change', () => {
            // Desactiva otros filtros
            filtroFechaInput.value = '';
            filtroMesSelect.value = '';
            filtroAnioSelect.value = '';
            resetearFiltrosEstado();
            renderCitas();
        });

        // Manejar el filtro de búsqueda de agentes
        filtroAgente.addEventListener('input', () => {
            mostrarModalAgentes();
        });

        // Manejar la selección de agente
        btnSeleccionarAgente.addEventListener('click', () => {
            if (agenteSeleccionado) {
                document.getElementById('agente').value = agenteSeleccionado.id;
                seleccionarAgenteModal.hide();
                agenteSeleccionado = null;
            }
        });

        // Manejar la carga de logo
        configLogo.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    logoPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Manejar el guardado de configuración
        btnGuardarConfiguracion.addEventListener('click', () => {
            configuracion.nombreEmpresa = configNombreEmpresa.value;
            configuracion.sucursal = configSucursal.value;
            configuracion.direccion = configDireccion.value;
            configuracion.telefono = configTelefono.value;
            configuracion.moneda = configMoneda.value;
            configuracion.formatoMoneda = configFormatoMoneda.value;
            
            // Guardar logo si se ha seleccionado uno nuevo
            if (configLogo.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    configuracion.logo = event.target.result;
                    guardarConfiguracion();
                };
                reader.readAsDataURL(configLogo.files[0]);
            } else {
                guardarConfiguracion();
            }
        });

        // Manejar el guardado de agente
        btnGuardarAgente.addEventListener('click', guardarAgente);

        // Manejar la eliminación de agente
        btnEliminarAgente.addEventListener('click', eliminarAgente);

        // Inicializar modal de gestión de agentes al mostrarse
        gestionAgentesModalEl.addEventListener('show.bs.modal', () => {
            // Si es un nuevo agente, limpiar el formulario
            if (!agenteIdInput.value) {
                agenteForm.reset();
                btnEliminarAgente.style.display = 'none';
            }
        });

        // Limpiar ID de agente al ocultar el modal
        gestionAgentesModalEl.addEventListener('hidden.bs.modal', () => {
            agenteIdInput.value = '';
        });
    </script>
</body>
</html>
